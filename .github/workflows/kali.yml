name: Build Custom Kali Linux ISO

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Desktop environment to include (gnome, lxde, xfce, kde, cli)'
        required: true
        default: 'gnome'

jobs:
  build_iso:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Setup Environment
        run: |
          sudo apt update
          sudo apt install -y git live-build simple-cdd cdebootstrap curl debootstrap neofetch
          wget https://kali.download/kali/pool/main/l/live-build/live-build_20230502+kali4_all.deb
          wget https://kali.download/kali/pool/main/k/kali-archive-keyring/kali-archive-keyring_2024.1_all.deb
          sudo dpkg -i kali-archive-keyring*.deb
          sudo dpkg -i live-build_20230502*.deb || sudo apt -f install -y
        shell: bash

      - name: Download and Setup Kali Live Build Config
        run: |
          git clone https://gitlab.com/kalilinux/build-scripts/live-build-config.git
          cd live-build-config
          neofetch
          # Create the .empty file with specified contents
        
          echo "kali-linux-core" > kali-config/variant-minimal/.empty
          echo "kali-linux-firmware" >> kali-config/variant-minimal/.empty
          echo "kali-system-cli" >> kali-config/variant-minimal/.empty
          echo "kali-desktop-live" >> kali-config/variant-minimal/.empty
        shell: bash

   

      - name: Configure ISO Build
        run: |


          # Set environment variables
          ENVIRONMENT="${{ github.event.inputs.environment }}"

          # Configure build settings
          case $ENVIRONMENT in
            gnome)
              ./build.sh --variant gnome --verbose --arch amd64
              ;;
            lxde)
              ./build.sh --variant lxde --verbose --arch amd64
              ;;
            xfce)
              ./build.sh --variant xfce --verbose --arch amd64
              ;;
            kde)
              lb config --distribution kali-rolling --desktop kde
              ;;
            cli)
               ./build.sh --variant minimal --verbose --arch amd64
              ;;
            *)
              echo "Unknown environment: $ENVIRONMENT"
              exit 1
              ;;
          esac
        shell: bash

      - name: Build the ISO
        run: |
          cd live-build-config
          lb build 2>&1 | tee build.log
        shell: bash

      - name: Check Build Status and Upload Log if Failed
        if: failure()
        run: |
          mkdir -p results
          mv live-build-config/build.log results/
        shell: bash

      - name: Archive the ISO
        if: success()
        run: |
          mkdir -p results
          mv live-build-config/images/*.iso results/
        shell: bash

      - name: Upload ISO Artifact
        if: success()
        uses: actions/upload-artifact@v3
        with:
          name: custom-kali-linux-iso
          path: results/*.iso

      - name: Upload Build Log Artifact
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: build-log
          path: results/build.log
